{% extends "base/03_functions_crud.sql.j2" %}
{% block header_comment %}
 * Template - 03_functions_crud.sql
 *
 * CRUD stored functions for bulk data operations. Organized in two levels:
 *
 *   Level 1 (Base) - Single-table operations:
 *     relay_insert, event_insert, metadata_insert,
 *     event_relay_insert, relay_metadata_insert,
 *     service_state_upsert, service_state_get, service_state_delete
 *
 *   Level 2 (Cascade) - Multi-table atomic operations that call Level 1:
 *     event_relay_insert_cascade  -> relay + event + event_relay
 *     relay_metadata_insert_cascade -> relay + metadata + relay_metadata
 *
 * IMPORTANT: Function signatures are fixed and called by src/bigbrotr/core/brotr.py.
 * All parameters must be accepted even if not stored. To customize event
 * storage, modify only the INSERT statement inside event_insert().
 *
 * Dependencies: 02_tables.sql
 * Customization: YES -- event_insert() INSERT statement (see examples)
{% endblock %}
{% block events_insert_comment %}
 * event_insert(BYTEA[], BYTEA[], BIGINT[], INTEGER[], JSONB[], TEXT[], BYTEA[]) -> INTEGER
 *
 * Bulk-inserts Nostr events. The function signature is fixed for interface
 * compatibility, but the INSERT statement should be customized to match
 * your event table schema.
 *
 * Customization examples:
 *
 *   Minimal table (only id):
 *     INSERT INTO event (id)
 *     SELECT id FROM unnest(p_event_ids) AS t(id)
 *
 *   Lightweight table (id, pubkey, created_at, kind, tagvalues):
 *     INSERT INTO event (id, pubkey, created_at, kind, tagvalues)
 *     SELECT id, pubkey, created_at, kind, tags_to_tagvalues(tags)
 *     FROM unnest(p_event_ids, p_pubkeys, p_created_ats, p_kinds, p_tags)
 *         AS t(id, pubkey, created_at, kind, tags)
 *
 *   Full table (all columns, used below):
 *     INSERT INTO event (id, pubkey, created_at, kind, tags, content, sig)
 *     SELECT * FROM unnest(p_event_ids, p_pubkeys, ...)
 *
 * Returns: Number of newly inserted rows
{% endblock %}
{% block events_insert_body %}
    -- CUSTOMIZE: Modify this INSERT to match your event table columns
    INSERT INTO event (id, pubkey, created_at, kind, tags, content, sig)
    SELECT * FROM unnest(
        p_event_ids,
        p_pubkeys,
        p_created_ats,
        p_kinds,
        p_tags,
        p_content_values,
        p_sigs
    ) AS t(id, pubkey, created_at, kind, tags, content, sig)
    ON CONFLICT (id) DO NOTHING;
{% endblock %}
