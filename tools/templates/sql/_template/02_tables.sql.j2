{% extends "base/02_tables.sql.j2" %}
{% block header_comment %}
 * Template - 02_tables.sql
 *
 * Core database tables for Nostr data storage. All tables except event
 * have fixed structures that must not be changed. The event table is
 * the primary customization point: only the id column is mandatory.
 *
 * Dependencies: 01_functions_utility.sql (only if using generated column for tagvalues)
 * Customization: YES -- event table columns can be customized (see examples below)
{% endblock %}
{% block events_table %}
-- ==========================================================================
-- event: Nostr event storage (CUSTOMIZABLE)
-- ==========================================================================
-- Only the id column (BYTEA PRIMARY KEY) is mandatory for the event_relay
-- foreign key. All other columns are optional. Customize the event_insert()
-- function in 03_functions_crud.sql to match your chosen schema.
--
-- Storage modes:
--
--   Minimal (tracking event IDs per relay only):
--     CREATE TABLE event (id BYTEA PRIMARY KEY);
--
--   Lightweight (metadata + tag filtering, ~60% disk savings):
--     CREATE TABLE event (
--         id BYTEA PRIMARY KEY,
--         pubkey BYTEA NOT NULL,
--         created_at BIGINT NOT NULL,
--         kind INTEGER NOT NULL,
--         tagvalues TEXT[]
--     );
--
--   Full (complete event reconstruction, used below):
--     Includes all NIP-01 fields with auto-computed tagvalues.

CREATE TABLE IF NOT EXISTS event (
    id BYTEA PRIMARY KEY,
    pubkey BYTEA NOT NULL,
    created_at BIGINT NOT NULL,
    kind INTEGER NOT NULL,
    tags JSONB NOT NULL,
    tagvalues TEXT [] GENERATED ALWAYS AS (tags_to_tagvalues(tags)) STORED,
    content TEXT NOT NULL,
    sig BYTEA NOT NULL
);

COMMENT ON TABLE event IS 'Nostr events with computed tag values for efficient querying';
COMMENT ON COLUMN event.id IS 'SHA-256 event hash (32 bytes, stored as bytea)';
COMMENT ON COLUMN event.pubkey IS 'Author public key (32 bytes, stored as bytea)';
COMMENT ON COLUMN event.created_at IS 'Unix timestamp of event creation';
COMMENT ON COLUMN event.kind IS 'Event kind per NIP-01 (0=metadata, 1=text note, 3=contacts, etc.)';
COMMENT ON COLUMN event.tags IS 'JSONB array of [key, value, ...] tag arrays per NIP-01';
COMMENT ON COLUMN event.tagvalues IS 'Auto-computed array of single-char tag values for GIN indexing';
COMMENT ON COLUMN event.content IS 'Event content (plaintext or encrypted depending on kind)';
COMMENT ON COLUMN event.sig IS 'Schnorr signature (64 bytes, stored as bytea)';
{% endblock %}
