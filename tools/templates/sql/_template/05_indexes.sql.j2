{% extends "base/08_indexes.sql.j2" %}
{% block header_comment %}
 * Template - 05_indexes.sql
 *
 * Performance indexes for tables. Based on common Nostr relay query patterns.
 * For minimal storage mode (event table with only id), remove the event
 * index section entirely since only the primary key index is needed.
 *
 * Dependencies: 02_tables.sql
 * Customization: YES -- adjust event indexes to match your table columns
{% endblock %}
{% block event_indexes %}
-- Global timeline queries: ORDER BY created_at DESC LIMIT N
CREATE INDEX IF NOT EXISTS idx_event_created_at
ON event USING btree (created_at DESC);

-- Kind filtering: WHERE kind = ? or WHERE kind IN (...)
CREATE INDEX IF NOT EXISTS idx_event_kind
ON event USING btree (kind);

-- Kind + timeline: WHERE kind = ? ORDER BY created_at DESC
CREATE INDEX IF NOT EXISTS idx_event_kind_created_at
ON event USING btree (kind, created_at DESC);

-- Author lookup: WHERE pubkey = ?
CREATE INDEX IF NOT EXISTS idx_event_pubkey
ON event USING btree (pubkey);

-- Tag value containment: WHERE tagvalues @> ARRAY['<value>']
-- Requires the btree_gin extension for GIN support on text arrays
CREATE INDEX IF NOT EXISTS idx_event_tagvalues
ON event USING gin (tagvalues);
{% endblock %}
{% block event_relay_indexes %}

-- All events from a relay: WHERE relay_url = ?
CREATE INDEX IF NOT EXISTS idx_event_relay_relay_url
ON event_relay USING btree (relay_url);

-- All relays for an event: WHERE event_id = ?
CREATE INDEX IF NOT EXISTS idx_event_relay_event_id
ON event_relay USING btree (event_id);
{% endblock %}
{% block matview_indexes %}
{% endblock %}
