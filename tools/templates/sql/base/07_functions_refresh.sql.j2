/*
{% block header_comment %}
 * Brotr - 07_functions_refresh.sql
 *
 * Refresh functions for materialized views. Each function wraps
 * REFRESH MATERIALIZED VIEW CONCURRENTLY, which rebuilds the view data
 * without blocking concurrent reads. Requires a unique index on each
 * materialized view (created in 08_indexes.sql).
 *
 * Dependencies: 06_materialized_views.sql
{% endblock %}
 */


{% block base_refresh_functions %}
/*
 * relay_metadata_latest_refresh() -> VOID
 *
 * Refreshes the relay_metadata_latest view concurrently.
 * Schedule: Daily via cron or application scheduler.
 */
CREATE OR REPLACE FUNCTION relay_metadata_latest_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY relay_metadata_latest;
END;
$$;

COMMENT ON FUNCTION relay_metadata_latest_refresh() IS
'Refresh relay_metadata_latest concurrently. Schedule daily.';
{% endblock %}
{% block extra_refresh_functions %}


/*
 * event_stats_refresh() -> VOID
 *
 * Refreshes the event_stats view concurrently.
 * Schedule: Hourly or as needed for dashboard accuracy.
 */
CREATE OR REPLACE FUNCTION event_stats_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY event_stats;
END;
$$;

COMMENT ON FUNCTION event_stats_refresh() IS
'Refresh event_stats concurrently.';


/*
 * relay_stats_refresh() -> VOID
 *
 * Refreshes the relay_stats view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION relay_stats_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY relay_stats;
END;
$$;

COMMENT ON FUNCTION relay_stats_refresh() IS
'Refresh relay_stats concurrently.';


/*
 * kind_counts_refresh() -> VOID
 *
 * Refreshes the kind_counts view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION kind_counts_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY kind_counts;
END;
$$;

COMMENT ON FUNCTION kind_counts_refresh() IS
'Refresh kind_counts concurrently.';


/*
 * kind_counts_by_relay_refresh() -> VOID
 *
 * Refreshes the kind_counts_by_relay view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION kind_counts_by_relay_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY kind_counts_by_relay;
END;
$$;

COMMENT ON FUNCTION kind_counts_by_relay_refresh() IS
'Refresh kind_counts_by_relay concurrently.';


/*
 * pubkey_counts_refresh() -> VOID
 *
 * Refreshes the pubkey_counts view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION pubkey_counts_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY pubkey_counts;
END;
$$;

COMMENT ON FUNCTION pubkey_counts_refresh() IS
'Refresh pubkey_counts concurrently.';


/*
 * pubkey_counts_by_relay_refresh() -> VOID
 *
 * Refreshes the pubkey_counts_by_relay view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION pubkey_counts_by_relay_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY pubkey_counts_by_relay;
END;
$$;

COMMENT ON FUNCTION pubkey_counts_by_relay_refresh() IS
'Refresh pubkey_counts_by_relay concurrently.';


/*
 * network_stats_refresh() -> VOID
 *
 * Refreshes the network_stats view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION network_stats_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY network_stats;
END;
$$;

COMMENT ON FUNCTION network_stats_refresh() IS
'Refresh network_stats concurrently.';


/*
 * relay_software_counts_refresh() -> VOID
 *
 * Refreshes the relay_software_counts view concurrently.
 * Depends on relay_metadata_latest being refreshed first.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION relay_software_counts_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY relay_software_counts;
END;
$$;

COMMENT ON FUNCTION relay_software_counts_refresh() IS
'Refresh relay_software_counts concurrently. Refresh relay_metadata_latest first.';


/*
 * supported_nip_counts_refresh() -> VOID
 *
 * Refreshes the supported_nip_counts view concurrently.
 * Depends on relay_metadata_latest being refreshed first.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION supported_nip_counts_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY supported_nip_counts;
END;
$$;

COMMENT ON FUNCTION supported_nip_counts_refresh() IS
'Refresh supported_nip_counts concurrently. Refresh relay_metadata_latest first.';


/*
 * event_daily_counts_refresh() -> VOID
 *
 * Refreshes the event_daily_counts view concurrently.
 * Schedule: Daily or as needed.
 */
CREATE OR REPLACE FUNCTION event_daily_counts_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY event_daily_counts;
END;
$$;

COMMENT ON FUNCTION event_daily_counts_refresh() IS
'Refresh event_daily_counts concurrently.';


/*
 * all_statistics_refresh() -> VOID
 *
 * Refreshes all materialized views in dependency order:
 * 1. relay_metadata_latest (base dependency for software/NIP views)
 * 2. Independent statistics views
 * 3. Views depending on relay_metadata_latest
 *
 * Best run during a maintenance window due to the aggregate I/O cost.
 * Schedule: Daily maintenance window.
 */
CREATE OR REPLACE FUNCTION all_statistics_refresh()
RETURNS VOID
LANGUAGE plpgsql
AS $$
BEGIN
    -- Level 1: base dependency
    PERFORM relay_metadata_latest_refresh();

    -- Level 2: independent views
    PERFORM event_stats_refresh();
    PERFORM relay_stats_refresh();
    PERFORM kind_counts_refresh();
    PERFORM kind_counts_by_relay_refresh();
    PERFORM pubkey_counts_refresh();
    PERFORM pubkey_counts_by_relay_refresh();
    PERFORM network_stats_refresh();
    PERFORM event_daily_counts_refresh();

    -- Level 3: depend on relay_metadata_latest
    PERFORM relay_software_counts_refresh();
    PERFORM supported_nip_counts_refresh();
END;
$$;

COMMENT ON FUNCTION all_statistics_refresh() IS
'Refresh all materialized views in dependency order. Run during maintenance windows.';
{% endblock %}
