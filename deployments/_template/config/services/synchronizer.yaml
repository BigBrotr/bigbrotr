# =============================================================================
# Synchronizer Service Configuration Template (All Default Values)
# =============================================================================
#
# Fetches Nostr events from relays and stores them in the database:
# 1. Selects readable relays from database (based on Monitor results)
# 2. Opens WebSocket connections to relays
# 3. Subscribes to events using configurable filters
# 4. Receives and stores events with relay associations
# 5. Tracks sync progress per relay using cursors
#
# Uses asyncio.TaskGroup with semaphore-bounded concurrency.
#
# Run mode: Continuous (runs every interval)
# Dependencies: Monitor must have checked relays first
# Configuration class: src/services/synchronizer.py::SynchronizerConfig
#
# Environment variables:
#   - PRIVATE_KEY: Required for NIP-42 authentication with relays
#
# =============================================================================

# -----------------------------------------------------------------------------
# Base Service Settings (inherited from BaseServiceConfig)
# -----------------------------------------------------------------------------
# Class: src/core/base_service.py::BaseServiceConfig

# Seconds between synchronization cycles
# Lower values = more frequent sync, higher resource usage
# Recommendation: 900-1800 for production
# Range: >= 60.0
# Default: 300.0
interval: 300.0

# Stop service after this many consecutive cycle failures
# Set to 0 for unlimited retries
# Range: >= 0
# Default: 5
max_consecutive_failures: 5

# -----------------------------------------------------------------------------
# Prometheus Metrics Configuration
# -----------------------------------------------------------------------------
# Class: src/core/metrics.py::MetricsConfig

metrics:
  # Enable or disable metrics collection and HTTP server
  # Default: false
  enabled: false

  # TCP port for the metrics HTTP server
  # In Docker, all services can use the same port (different containers)
  # Range: 1024-65535
  # Default: 8000
  port: 8000

  # IP address to bind the metrics server to
  # Use "0.0.0.0" for Docker/container environments
  # Default: "127.0.0.1"
  host: "127.0.0.1"

  # URL path for the metrics endpoint
  # Default: "/metrics"
  path: "/metrics"

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
# Per-network settings for relay synchronization.
# timeout here is the WebSocket request timeout for each event fetch.
# Class: src/services/common/configs.py::NetworkConfig

networks:
  # Clearnet (standard internet relays)
  clearnet:
    enabled: true
    proxy_url: null
    max_tasks: 50
    timeout: 10.0

  # Tor (.onion relays) - requires Tor proxy
  tor:
    enabled: false
    proxy_url: "socks5://tor:9050"
    max_tasks: 10
    timeout: 30.0

  # I2P (.i2p relays) - requires I2P router
  i2p:
    enabled: false
    proxy_url: "socks5://i2p:4447"
    max_tasks: 5
    timeout: 45.0

  # Lokinet (.loki relays) - requires Lokinet (Linux only)
  loki:
    enabled: false
    proxy_url: "socks5://lokinet:1080"
    max_tasks: 5
    timeout: 30.0

# -----------------------------------------------------------------------------
# Nostr Keys Configuration
# -----------------------------------------------------------------------------
# Keys are loaded from PRIVATE_KEY environment variable automatically.
# Required for NIP-42 authentication with relays that require it.
# Class: src/utils/keys.py::KeysConfig
#
# NEVER store private keys in configuration files.
# Set via: export PRIVATE_KEY="nsec1..." or hex format

keys: {}

# -----------------------------------------------------------------------------
# Event Filter Configuration
# -----------------------------------------------------------------------------
# Controls which events to fetch from relays.
# Set to null to accept all values for that field.
# Class: src/services/synchronizer.py::FilterConfig

filter:
  # Specific event IDs to sync (64-char hex strings)
  # null = sync all event IDs
  # Example: ["abc123...", "def456..."]
  # Default: null
  ids: null

  # Event kinds to sync
  # null = sync all event kinds
  # Example: [0, 1, 3, 10002] for profiles, notes, contacts, relay lists
  # Range per kind: 0-65535
  # Default: null
  kinds: null

  # Specific author pubkeys to sync (64-char hex strings)
  # null = sync all authors
  # Example: ["pubkey1...", "pubkey2..."]
  # Default: null
  authors: null

  # Tag filters
  # null = no tag filtering
  # Format: {"e": ["event_id"], "p": ["pubkey"], "t": ["hashtag"]}
  # Default: null
  tags: null

  # Maximum events per request batch
  # Higher values = fewer requests, more memory per batch
  # Range: 1-5000
  # Default: 500
  limit: 500

# -----------------------------------------------------------------------------
# Time Range Configuration
# -----------------------------------------------------------------------------
# Controls the time window for event synchronization.
# Class: src/services/synchronizer.py::TimeRangeConfig

time_range:
  # Default start timestamp when no cursor exists for a relay
  # 0 = sync from epoch (all historical events)
  # Set to recent timestamp for new deployments to skip old events
  # Range: >= 0
  # Default: 0
  default_start: 0

  # Use per-relay cursor for incremental sync
  # true = resume from last synced position (recommended)
  # false = always start from default_start (re-sync everything)
  # Default: true
  use_relay_state: true

  # Lookback window from current time (seconds)
  # Only fetch events up to (now - lookback_seconds)
  # Prevents syncing events that may not be fully propagated
  # Range: 3600-604800 (1 hour to 7 days)
  # Default: 86400 (24 hours)
  lookback_seconds: 86400

# -----------------------------------------------------------------------------
# Per-Relay Sync Timeouts
# -----------------------------------------------------------------------------
# Maximum time allowed for syncing each relay (per relay session).
# This is separate from the WebSocket request timeout in networks.*.timeout.
# Class: src/services/synchronizer.py::SyncTimeoutsConfig

sync_timeouts:
  # Maximum time (seconds) for syncing a clearnet relay
  # Range: 60.0-14400.0
  # Default: 1800.0 (30 minutes)
  relay_clearnet: 1800.0

  # Maximum time (seconds) for syncing a Tor relay
  # Range: 60.0-14400.0
  # Default: 3600.0 (1 hour)
  relay_tor: 3600.0

  # Maximum time (seconds) for syncing an I2P relay
  # Range: 60.0-14400.0
  # Default: 3600.0 (1 hour)
  relay_i2p: 3600.0

  # Maximum time (seconds) for syncing a Lokinet relay
  # Range: 60.0-14400.0
  # Default: 3600.0 (1 hour)
  relay_loki: 3600.0

# -----------------------------------------------------------------------------
# Concurrency Configuration
# -----------------------------------------------------------------------------
# Controls parallel execution of relay synchronization.
# Class: src/services/synchronizer.py::SyncConcurrencyConfig

concurrency:
  # Maximum parallel relay connections (bounded by asyncio.Semaphore)
  # Higher values = faster sync, more memory/network usage
  # Range: 1-100
  # Default: 10
  max_parallel: 10

  # Random delay range [min, max] seconds before starting each relay
  # Prevents thundering herd on startup
  # Default: [0, 60]
  stagger_delay: [0, 60]

# -----------------------------------------------------------------------------
# Relay Source Configuration
# -----------------------------------------------------------------------------
# Controls which relays to sync from.
# Class: src/services/synchronizer.py::SourceConfig

source:
  # Fetch relay list from database
  # true = query relays table for sync targets
  # false = only use overrides list (manual relay selection)
  # Default: true
  from_database: true

  # Only sync relays with metadata updated within N seconds
  # Ensures relays have been recently checked by Monitor
  # Range: >= 0 (0 = no age limit)
  # Default: 43200 (12 hours)
  max_metadata_age: 43200

  # Only sync relays marked as readable by Monitor
  # true = skip relays that failed read tests
  # false = attempt sync on all relays regardless of read status
  # Default: true
  require_readable: true

# -----------------------------------------------------------------------------
# Relay Overrides
# -----------------------------------------------------------------------------
# Custom timeout settings for specific relays.
# Useful for large or slow relays that need extended timeouts.
# Class: src/services/synchronizer.py::RelayOverride

overrides: []
  # Example:
  # - url: "wss://relay.damus.io"
  #   timeouts:
  #     request: 60.0     # WebSocket request timeout (overrides networks.*.timeout)
  #     relay: 7200.0     # Per-relay sync timeout (overrides sync_timeouts.relay_*)

# =============================================================================
# CUSTOMIZATION GUIDE
# =============================================================================
#
# SPECIFIC EVENT KINDS ONLY:
#   filter.kinds: [0, 1, 3, 10002]  # profiles, notes, contacts, relay lists
#
# MINIMAL RESOURCES (low throughput, low resource usage):
#   interval: 1800.0
#   concurrency.max_parallel: 5
#   filter.limit: 200
#
# AGGRESSIVE SYNC (high throughput, high resource usage):
#   interval: 300.0
#   concurrency.max_parallel: 50
#   filter.limit: 1000
#
# DISABLE OVERLAY NETWORKS:
#   networks.tor.enabled: false
#   networks.i2p.enabled: false
#   networks.loki.enabled: false
#
# FULL HISTORICAL SYNC:
#   time_range.default_start: 1672531200  # Jan 1, 2023
#   time_range.lookback_seconds: 604800   # 7 days
#
# LARGE RELAY OVERRIDE:
#   overrides:
#     - url: "wss://relay.damus.io"
#       timeouts:
#         request: 60.0
#         relay: 7200.0
#
# CUSTOM METRICS PORT:
#   metrics.port: 8004
#
# =============================================================================
