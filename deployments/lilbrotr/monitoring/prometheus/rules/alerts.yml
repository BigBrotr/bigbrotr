# ============================================================================
# LilBrotr Prometheus Alerting Rules
# ============================================================================
# Alerts for service health, failure rates, pool exhaustion, and query latency.
# ============================================================================

groups:
  - name: lilbrotr
    rules:
      # --------------------------------------------------------------------
      # ServiceDown: Target unreachable for more than 5 minutes
      # --------------------------------------------------------------------
      - alert: ServiceDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }} is down"
          description: >-
            The {{ $labels.job }} service at {{ $labels.instance }} has been
            unreachable for more than 5 minutes.

      # --------------------------------------------------------------------
      # HighFailureRate: Error counter increasing rapidly
      # --------------------------------------------------------------------
      - alert: HighFailureRate
        expr: >-
          rate(bigbrotr_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High failure rate on {{ $labels.job }}"
          description: >-
            {{ $labels.job }} is experiencing more than 0.1 errors/second
            over the last 5 minutes (current: {{ $value | printf "%.2f" }}/s).

      # --------------------------------------------------------------------
      # PoolExhausted: Connection pool at capacity
      # --------------------------------------------------------------------
      - alert: PoolExhausted
        expr: >-
          bigbrotr_pool_available_connections == 0
          and bigbrotr_pool_max_connections > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Connection pool exhausted on {{ $labels.job }}"
          description: >-
            {{ $labels.job }} has zero available database connections for
            more than 2 minutes. Queries will queue or timeout.

      # --------------------------------------------------------------------
      # DatabaseSlow: Query duration p99 exceeding threshold
      # --------------------------------------------------------------------
      - alert: DatabaseSlow
        expr: >-
          histogram_quantile(0.99,
            rate(bigbrotr_query_duration_seconds_bucket[5m])
          ) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries on {{ $labels.job }}"
          description: >-
            The p99 query duration for {{ $labels.job }} exceeds 5 seconds
            (current: {{ $value | printf "%.1f" }}s).
