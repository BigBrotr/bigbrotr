# ============================================================================
# postgres_exporter Custom Queries for LilBrotr
# ============================================================================
# These queries expose application-level database metrics as Prometheus gauges.
# Scraped every 30s by Prometheus via postgres_exporter.
#
# Design decisions:
#   - relay/metadata/service_state: COUNT(*) is fine (small tables, <10k rows)
#   - event: uses pg_class.reltuples (O(1) approximation, ~95% accurate after ANALYZE)
#   - No materialized view dependency: all queries hit base tables or pg_catalog
# ============================================================================

lilbrotr_overview:
  query: |
    SELECT
      (SELECT COUNT(*)::float FROM relay) AS relay_count,
      (SELECT reltuples FROM pg_class WHERE relname = 'event') AS event_count_approx,
      (SELECT COUNT(*)::float FROM metadata) AS metadata_count,
      (SELECT COUNT(*)::float FROM service_state) AS service_state_count
  metrics:
    - relay_count:
        usage: "GAUGE"
        description: "Total relays in database"
    - event_count_approx:
        usage: "GAUGE"
        description: "Approximate total events (from pg_class.reltuples)"
    - metadata_count:
        usage: "GAUGE"
        description: "Total unique metadata records"
    - service_state_count:
        usage: "GAUGE"
        description: "Active service state entries"

lilbrotr_relay_by_network:
  query: "SELECT network, COUNT(*)::float AS count FROM relay GROUP BY network"
  metrics:
    - network:
        usage: "LABEL"
        description: "Network type (clearnet, tor, i2p, loki)"
    - count:
        usage: "GAUGE"
        description: "Number of relays per network type"

lilbrotr_table_sizes:
  query: |
    SELECT relname AS table_name,
           pg_total_relation_size(relid)::float AS total_bytes
    FROM pg_catalog.pg_statio_user_tables
    ORDER BY pg_total_relation_size(relid) DESC
  metrics:
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total size of table including indexes (bytes)"

lilbrotr_candidates:
  query: |
    SELECT COUNT(*)::float AS queue_depth
    FROM service_state
    WHERE service_name = 'validator'
      AND state_type = 'candidate'
  metrics:
    - queue_depth:
        usage: "GAUGE"
        description: "Total candidates in validation queue"
