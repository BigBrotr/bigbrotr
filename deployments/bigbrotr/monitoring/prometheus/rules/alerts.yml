# ============================================================================
# BigBrotr Prometheus Alerting Rules
# ============================================================================
# Alerts for service health, failure rates, and cycle latency.
#
# Metric reference (from core/metrics.py):
#   service_counter_total{service, name}  -- cumulative counters
#   service_gauge{service, name}          -- point-in-time gauges
#   cycle_duration_seconds                -- histogram with service label
# ============================================================================

groups:
  - name: bigbrotr
    rules:
      # --------------------------------------------------------------------
      # ServiceDown: Target unreachable for more than 5 minutes
      # --------------------------------------------------------------------
      - alert: ServiceDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }} is down"
          description: >-
            The {{ $labels.job }} service at {{ $labels.instance }} has been
            unreachable for more than 5 minutes.

      # --------------------------------------------------------------------
      # HighFailureRate: Error counters increasing rapidly
      # --------------------------------------------------------------------
      - alert: HighFailureRate
        expr: >-
          sum by (service) (
            rate(service_counter_total{name=~"errors_.*"}[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High failure rate on {{ $labels.service }}"
          description: >-
            {{ $labels.service }} is experiencing more than 0.1 errors/second
            over the last 5 minutes (current: {{ $value | printf "%.2f" }}/s).

      # --------------------------------------------------------------------
      # ConsecutiveFailures: Service failing repeatedly
      # --------------------------------------------------------------------
      - alert: ConsecutiveFailures
        expr: >-
          service_gauge{name="consecutive_failures"} >= 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.service }} has {{ $value }} consecutive failures"
          description: >-
            {{ $labels.service }} has failed {{ $value }} consecutive cycles.
            Investigate logs for root cause.

      # --------------------------------------------------------------------
      # SlowCycles: Cycle duration p99 exceeding threshold
      # --------------------------------------------------------------------
      - alert: SlowCycles
        expr: >-
          histogram_quantile(0.99,
            rate(cycle_duration_seconds_bucket[5m])
          ) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow cycles on {{ $labels.service }}"
          description: >-
            The p99 cycle duration for {{ $labels.service }} exceeds 5 minutes
            (current: {{ $value | printf "%.0f" }}s).

      # --------------------------------------------------------------------
      # DatabaseConnectionsHigh: Too many active connections
      # --------------------------------------------------------------------
      - alert: DatabaseConnectionsHigh
        expr: >-
          sum(pg_stat_activity_count{datname="bigbrotr"}) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection count: {{ $value }}"
          description: >-
            PostgreSQL has {{ $value }} active connections, exceeding the
            warning threshold of 80. Check for connection leaks or increase
            pool limits.

      # --------------------------------------------------------------------
      # CacheHitRatioLow: Buffer cache not effective
      # --------------------------------------------------------------------
      - alert: CacheHitRatioLow
        expr: >-
          pg_stat_database_blks_hit{datname="bigbrotr"}
          / (pg_stat_database_blks_hit{datname="bigbrotr"}
             + pg_stat_database_blks_read{datname="bigbrotr"}) < 0.95
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Cache hit ratio below 95%: {{ $value | printf \"%.3f\" }}"
          description: >-
            PostgreSQL buffer cache hit ratio is {{ $value | printf "%.1f" }}%,
            below the 95% threshold. Consider increasing shared_buffers.
