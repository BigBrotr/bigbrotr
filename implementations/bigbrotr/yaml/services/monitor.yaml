# ============================================================================
# Monitor Service Configuration (BigBrotr)
# ============================================================================
# Description: Monitor relay health and capabilities with full NIP-66 compliance
# Used by: src/services/monitor.py
# Dependencies: Validator must have validated relays first
# Environment: PRIVATE_KEY required if publishing enabled
# Notes: Uses overlay network proxies for hidden relay monitoring (.onion, .i2p, .loki)
# ============================================================================

# Cycle interval (seconds between monitoring runs)
# Range: >= 60.0
interval: 3600.0

# Prometheus metrics
metrics:
  enabled: true
  port: 8003
  host: "0.0.0.0"
  path: "/metrics"

# Unified network configuration
# Each network type has: enabled, proxy_url, max_tasks, timeout
networks:
  clearnet:
    enabled: true
    max_tasks: 50              # High concurrency for fast clearnet relays
    timeout: 30.0              # Timeout for relay checks

  tor:
    enabled: true
    proxy_url: "socks5://tor:9050"
    max_tasks: 10              # Lower concurrency (Tor is slower)
    timeout: 60.0              # Longer timeout for Tor latency

  i2p:
    enabled: false             # Disabled by default (enable i2p service in docker-compose first)
    proxy_url: "socks5://i2p:4447"
    max_tasks: 5               # Even lower (I2P is slowest)
    timeout: 90.0              # Longest timeout for I2P

  loki:
    enabled: false             # Disabled by default (requires Lokinet - Linux only)
    proxy_url: "socks5://lokinet:1080"
    max_tasks: 5
    timeout: 60.0

# Nostr signing keys
# Private key is loaded from PRIVATE_KEY environment variable
# Required for: write tests (nip66_probe), publishing (discovery, announcement, profile)
keys:
  # Keys are loaded from environment variable, no config needed here

# Default relay list for publishing events
# Used by discovery, announcement, and profile if their relays list is empty
publishing:
  relays:
    # - wss://relay.damus.io
    # - wss://nos.lol
    # - wss://relay.nostr.band

# Kind 30166 relay discovery events
# Publishes relay metadata to the Nostr network
discovery:
  enabled: true
  interval: 3600             # Seconds between re-checking a relay (Range: >= 60)
  include:                   # Which metadata to include in events (⊆ processing.compute)
    nip11: true              # NIP-11 relay information document
    nip66_rtt: true          # Round-trip time measurements
    nip66_probe: true        # Probe test results (open/read/write restrictions)
    nip66_ssl: true          # SSL certificate validation
    nip66_geo: true          # Geolocation (country, city, coordinates)
    nip66_net: true          # Network/ASN info (IP, ASN, organization)
    nip66_dns: true          # DNS resolution time
    nip66_http: true         # HTTP response codes
  relays:                    # Override publishing.relays (empty = use publishing.relays)

# Kind 10166 monitor announcement
# Announces this monitor's existence and capabilities to the network
announcement:
  enabled: true
  interval: 86400            # Seconds between announcements (Range: >= 60)
  relays:                    # Override publishing.relays (empty = use publishing.relays)

# Kind 0 profile
# Publishes monitor's profile metadata
profile:
  enabled: false
  interval: 86400            # Seconds between profile updates (Range: >= 60)
  relays:                    # Override publishing.relays (empty = use publishing.relays)
  # Profile content (NIP-01)
  # name: "BigBrotr Monitor"
  # about: "NIP-66 relay monitor"
  # picture: "https://example.com/avatar.png"
  # nip05: "monitor@example.com"
  # website: "https://example.com"
  # banner: "https://example.com/banner.png"
  # lud16: "monitor@getalby.com"

# Geolocation configuration
# MaxMind GeoLite2 databases are auto-downloaded from GitHub mirror if missing
geo:
  city_database_path: "static/GeoLite2-City.mmdb"
  asn_database_path: "static/GeoLite2-ASN.mmdb"
  city_download_url: "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb"
  asn_download_url: "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-ASN.mmdb"
  max_age_days: 30  # null = never update

# Processing settings
# Controls what metadata is computed and stored
# Dependency chain: compute → store → discovery.include
# (can only store what is computed, can only publish what is computed)
processing:
  chunk_size: 100              # Relays per batch (Range: 10 - 1000)
  # max_relays: 500            # Optional limit on total relays per cycle
  nip11_max_size: 1048576      # Max NIP-11 response size in bytes (1MB default)
  compute:                     # What metadata to compute
    nip11: true                # NIP-11 relay information document
    nip66_rtt: true            # Round-trip time (open/read/write latency)
    nip66_probe: true          # Probe test results with raw rejection reasons
    nip66_ssl: true            # SSL certificate chain validation
    nip66_geo: true            # IP geolocation (requires MaxMind City database)
    nip66_net: true            # Network/ASN info (requires MaxMind ASN database)
    nip66_dns: true            # DNS resolution timing
    nip66_http: true           # HTTP status codes
  store:                       # What metadata to store in database (⊆ compute)
    nip11: true
    nip66_rtt: true
    nip66_probe: true
    nip66_ssl: true
    nip66_geo: true
    nip66_net: true
    nip66_dns: true
    nip66_http: true
