# ============================================================================
# BigBrotr Implementation Template - Synchronizer Service Configuration
# ============================================================================
# Description: Synchronize Nostr events from relays to the database
# Used by: src/services/synchronizer.py
# Run mode: Continuous (runs every interval)
# Dependencies: Monitor must have checked relays first
# Notes: Uses overlay network proxies for hidden relay synchronization (.onion, .i2p, .loki)
# ============================================================================
#
# PURPOSE:
# The Synchronizer service fetches Nostr events from relays and stores them:
# 1. Selects readable relays from database (based on Monitor results)
# 2. Opens WebSocket connections to relays
# 3. Subscribes to events using configurable filters
# 4. Receives and stores events with relay associations
# 5. Tracks sync progress per relay using cursors
#
# Supports multicore processing for high-throughput synchronization.
#
# ============================================================================

# Cycle interval (seconds between sync runs)
# Range: >= 60.0
# Recommendation: 900-1800 for production (15-30 minutes)
interval: 900.0

# Prometheus metrics and health checks
metrics:
  enabled: true
  port: 8004
  host: "0.0.0.0"
  path: "/metrics"
  health:
    max_cycle_age_seconds: 3600.0  # Unhealthy if no cycle in 1 hour

# Unified network configuration
# Each network type has: enabled, proxy_url, max_tasks, timeout
# timeout here is the WebSocket request timeout
networks:
  clearnet:
    enabled: true
    max_tasks: 10              # Concurrent connections per process
    timeout: 30.0              # WebSocket request timeout

  tor:
    enabled: true
    proxy_url: "socks5://tor:9050"
    max_tasks: 5               # Lower concurrency (Tor is slower)
    timeout: 60.0              # Longer timeout for Tor latency

  i2p:
    enabled: false             # Disabled by default (enable i2p service in docker-compose first)
    proxy_url: "socks5://i2p:4447"
    max_tasks: 3               # Even lower (I2P is slowest)
    timeout: 90.0              # Longest timeout for I2P

  loki:
    enabled: false             # Disabled by default (requires Lokinet - Linux only)
    proxy_url: "socks5://lokinet:1080"
    max_tasks: 3
    timeout: 60.0

# Nostr signing keys
# Private key is loaded from PRIVATE_KEY environment variable
# Used for NIP-42 authentication with relays that require it
keys:
  # Keys are loaded from environment variable, no config needed here

# Event filter settings
# Set to null to accept all values for that field
filter:
  ids: null                   # Specific event IDs to sync (null = all)
  kinds: null                 # Event kinds to sync (null = all)
                              # Example: [0, 1, 3, 10002] for profiles, notes, contacts, relay lists
  authors: null               # Specific author pubkeys to sync (null = all)
  tags: null                  # Tag filters (null = all)
                              # Format: {"e": ["event_id"], "p": ["pubkey"]}
  limit: 500                  # Events per request batch (Range: 1 - 5000)

# Time range for sync
time_range:
  default_start: 0            # Default start timestamp (0 = epoch, Range: >= 0)
  use_relay_state: true       # Use per-relay cursor for incremental sync
  lookback_seconds: 86400     # Lookback window in seconds (Range: 3600 - 604800)
                              # Default: 24 hours (86400)

# Per-relay sync timeouts (max time per relay sync session)
# WebSocket request timeout comes from networks.*.timeout above
sync_timeouts:
  relay_clearnet: 1800.0      # Max time per clearnet relay sync (30 min)
  relay_tor: 3600.0           # Max time per Tor relay sync (60 min)
  relay_i2p: 3600.0           # Max time per I2P relay sync (60 min)
  relay_loki: 3600.0          # Max time per Loki relay sync (60 min)

# Concurrency settings
concurrency:
  max_parallel: 10            # Max parallel relay connections per process (Range: 1 - 100)
  max_processes: 4            # Number of worker processes (Range: 1 - 32)
  stagger_delay: [0, 60]      # Random delay range [min, max] seconds
                              # Prevents thundering herd on startup

# Relay source - which relays to sync from
source:
  from_database: true         # Fetch relay list from database
  max_metadata_age: 43200     # Only sync relays checked within N seconds (Range: >= 0)
                              # Default: 12 hours (43200)
  require_readable: true      # Only sync relays marked as readable by Monitor

# Override settings for specific relays (optional)
# Useful for large or slow relays that need custom timeouts
overrides: []
  # Example:
  # - url: "wss://relay.damus.io"
  #   timeouts:
  #     request: 60.0
  #     relay: 7200.0

# ============================================================================
# CUSTOMIZATION NOTES
# ============================================================================
#
# SPECIFIC EVENT KINDS ONLY:
#   filter.kinds: [0, 1, 3]   # Only profiles, notes, contacts
#
# LIGHTWEIGHT STORAGE:
#   If using lightweight events table (no tags/content/sig), the service
#   automatically handles this - no config change needed.
#
# MINIMAL RESOURCES:
#   interval: 1800.0
#   concurrency.max_parallel: 5
#   concurrency.max_processes: 1
#   filter.limit: 200
#
# AGGRESSIVE SYNC:
#   interval: 300.0
#   concurrency.max_parallel: 25
#   concurrency.max_processes: 8
#   filter.limit: 1000
#
# DISABLE OVERLAY NETWORKS:
#   networks.tor.enabled: false
#   networks.i2p.enabled: false
#   networks.loki.enabled: false
#
# FULL HISTORICAL SYNC:
#   time_range.default_start: 1672531200  # Jan 1, 2023
#   time_range.lookback_seconds: 604800   # 7 days
#
# ============================================================================
