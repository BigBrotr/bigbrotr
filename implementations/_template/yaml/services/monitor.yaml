# ============================================================================
# BigBrotr Implementation Template - Monitor Service Configuration
# ============================================================================
# Description: Monitor relay health and collect NIP-11/NIP-66 metadata
# Used by: src/services/monitor.py
# Run mode: Continuous (runs every interval)
# Dependencies: Validator must have validated relays first
# Environment: PRIVATE_KEY required for write tests and NIP-66 publishing
# ============================================================================
#
# PURPOSE:
# The Monitor service performs health checks on validated relays:
# 1. Tests WebSocket connectivity (open)
# 2. Tests subscription capability (read)
# 3. Tests event publication (write, requires PRIVATE_KEY)
# 4. Fetches NIP-11 relay info document
# 5. Validates SSL/TLS certificate
# 6. Measures DNS resolution time
# 7. Geolocates relay IP address
# 8. Stores results as NIP-66 metadata
#
# ============================================================================

# Cycle interval (seconds between monitoring runs)
# Range: >= 60.0
# Recommendation: 3600-7200 for production (1-2 hours)
interval: 3600.0

# Prometheus metrics and health checks
metrics:
  enabled: true
  port: 8003
  host: "0.0.0.0"
  path: "/metrics"

# Unified network configuration
# Each network type has: enabled, proxy_url, max_tasks, timeout
networks:
  clearnet:
    enabled: true
    max_tasks: 50              # High concurrency for fast clearnet relays
    timeout: 30.0              # Timeout for relay checks (Range: 5.0 - 120.0)

  tor:
    enabled: true
    proxy_url: "socks5://tor:9050"
    max_tasks: 10              # Lower concurrency (Tor is slower)
    timeout: 60.0              # Longer timeout for Tor latency

  i2p:
    enabled: false             # Disabled by default
    proxy_url: "socks5://i2p:4447"
    max_tasks: 5
    timeout: 90.0

  loki:
    enabled: false             # Disabled by default
    proxy_url: "socks5://lokinet:1080"
    max_tasks: 5
    timeout: 60.0

# Nostr signing keys
# Private key is loaded from PRIVATE_KEY environment variable
# Required for: write tests (nip66_probe), publishing (discovery, announcement, profile)
keys:
  # Keys are loaded from environment variable, no config needed here

# Default relay list for publishing events
# Used by discovery, announcement, and profile if their relays list is empty
publishing:
  relays:
    # - wss://relay.damus.io
    # - wss://nos.lol
    # - wss://relay.nostr.band

# Kind 30166 relay discovery events
# Publishes relay metadata to the Nostr network
discovery:
  enabled: true
  interval: 3600             # Seconds between re-checking a relay (Range: >= 60)
  include:                   # Which metadata to include in events (⊆ processing.compute)
    nip11: true              # NIP-11 relay information document
    nip66_rtt: true          # Round-trip time measurements
    nip66_probe: true        # Probe test results (open/read/write restrictions)
    nip66_ssl: true          # SSL certificate validation
    nip66_geo: true          # Geolocation (country, city, coordinates)
    nip66_net: true          # Network/ASN info (IP, ASN, organization)
    nip66_dns: true          # DNS resolution time
    nip66_http: true         # HTTP response codes
  relays:                    # Override publishing.relays (empty = use publishing.relays)

# Kind 10166 monitor announcement
# Announces this monitor's existence and capabilities to the network
announcement:
  enabled: true
  interval: 86400            # Seconds between announcements (Range: >= 60)
  relays:                    # Override publishing.relays (empty = use publishing.relays)

# Kind 0 profile
# Publishes monitor's profile metadata
profile:
  enabled: false
  interval: 86400            # Seconds between profile updates (Range: >= 60)
  relays:                    # Override publishing.relays (empty = use publishing.relays)
  # Profile content (NIP-01)
  # name: "My Monitor"
  # about: "NIP-66 relay monitor"
  # picture: "https://example.com/avatar.png"
  # nip05: "monitor@example.com"
  # website: "https://example.com"
  # banner: "https://example.com/banner.png"
  # lud16: "monitor@getalby.com"

# Geolocation configuration
# MaxMind GeoLite2 databases are auto-downloaded from GitHub mirror if missing
geo:
  city_database_path: "static/GeoLite2-City.mmdb"
  asn_database_path: "static/GeoLite2-ASN.mmdb"
  city_download_url: "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb"
  asn_download_url: "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-ASN.mmdb"
  max_age_days: 30  # null = never update

# Processing settings
# Controls what metadata is computed and stored
# Dependency chain: compute → store → discovery.include
processing:
  chunk_size: 100              # Relays per batch (Range: 10 - 1000)
  # max_relays: 500            # Optional limit on total relays per cycle
  nip11_max_size: 1048576      # Max NIP-11 response size in bytes (1MB)
  compute:                     # What metadata to compute
    nip11: true
    nip66_rtt: true
    nip66_probe: true
    nip66_ssl: true
    nip66_geo: true
    nip66_net: true
    nip66_dns: true
    nip66_http: true
  store:                       # What metadata to store in database (⊆ compute)
    nip11: true
    nip66_rtt: true
    nip66_probe: true
    nip66_ssl: true
    nip66_geo: true
    nip66_net: true
    nip66_dns: true
    nip66_http: true

# ============================================================================
# CUSTOMIZATION NOTES
# ============================================================================
#
# NO GEOLOCATION:
#   processing.compute.nip66_geo: false
#   processing.store.nip66_geo: false
#   discovery.include.nip66_geo: false
#
# NO WRITE TESTS (no PRIVATE_KEY needed):
#   processing.compute.nip66_rtt: false  # RTT includes write test
#
# DATABASE ONLY (no Nostr publishing):
#   discovery.enabled: false
#   announcement.enabled: false
#   profile.enabled: false
#
# MINIMAL RESOURCES:
#   interval: 7200.0
#   networks.clearnet.max_tasks: 10
#   processing.chunk_size: 20
#   processing.compute:
#     nip11: true
#     nip66_rtt: false
#     nip66_probe: false
#     nip66_ssl: false
#     nip66_geo: false
#     nip66_net: false
#     nip66_dns: false
#     nip66_http: false
#
# ============================================================================
