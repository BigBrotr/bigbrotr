# ============================================================================
# BigBrotr Implementation Template - Brotr Configuration
# ============================================================================
# Description: Database connection pool and operation settings
# Used by: src/core/brotr.py (Brotr class)
# Customization: Update database name, pool sizes, timeouts as needed
# ============================================================================

# Connection pool configuration
pool:
  # Database connection parameters
  # Connects to PGBouncer for connection pooling
  database:
    host: pgbouncer           # Docker service name
    port: 5432                # PGBouncer internal port (mapped to 6432 externally)
    database: myimpl          # <-- CUSTOMIZE: Your database name
    user: admin               # Database user
    # password: loaded from DB_PASSWORD environment variable (never stored here)

  # Connection pool sizing
  # These are connections to PGBouncer, which then pools to PostgreSQL
  limits:
    min_size: 5               # Minimum idle connections
    max_size: 20              # Maximum total connections
    max_queries: 50000        # Queries per connection before recycling
    max_inactive_connection_lifetime: 300.0  # Seconds before idle connection closed

  # Timeout settings for connection acquisition and health checks
  timeouts:
    acquisition: 10.0         # Seconds to wait for available connection
    health_check: 5.0         # Seconds for connection health check

  # Retry logic for transient connection failures
  retry:
    max_attempts: 3           # Maximum retry attempts
    initial_delay: 1.0        # Initial delay between retries (seconds)
    max_delay: 10.0           # Maximum delay between retries (seconds)
    exponential_backoff: true # Use exponential backoff

  # PostgreSQL server settings (sent on connection)
  server_settings:
    application_name: myimpl  # <-- CUSTOMIZE: Application name in pg_stat_activity
    timezone: UTC             # Database timezone

# Batch operation settings
# Controls memory usage and database round-trips
batch:
  max_batch_size: 1000        # Maximum records per batch insert
                              # Higher = fewer round-trips, more memory
                              # Lower = more round-trips, less memory

# Query timeouts for different operation types (seconds)
# null = no timeout (infinite)
timeouts:
  query: 60.0                 # Standard SELECT/UPDATE/DELETE queries
  batch: 120.0                # Bulk INSERT operations
  cleanup: 90.0               # Cleanup procedures (orphan_*_delete, failed_candidates_delete)
  refresh: null               # Materialized view refresh (can be slow on large datasets)

# ============================================================================
# CUSTOMIZATION NOTES
# ============================================================================
#
# SMALL DEPLOYMENT (< 100 relays, < 1M events):
#   pool.limits.min_size: 2
#   pool.limits.max_size: 10
#   batch.max_batch_size: 500
#
# LARGE DEPLOYMENT (> 1000 relays, > 10M events):
#   pool.limits.min_size: 10
#   pool.limits.max_size: 50
#   batch.max_batch_size: 5000
#
# HIGH LATENCY DATABASE (remote PostgreSQL):
#   pool.timeouts.acquisition: 30.0
#   pool.timeouts.health_check: 10.0
#   pool.retry.max_attempts: 5
#
# ============================================================================
