# BigBrotr v3.0.0 Release Notes

**Release Date**: Pending

---

## Release Status

This is a **draft release**. The following items require completion before final release:

### Completed

- [x] Three-layer architecture (Implementation / Service / Core / Models)
- [x] Complete data models layer with frozen dataclasses
- [x] Service communication via `service_data` table
- [x] Unit test suite (708 tests passing)
- [x] Documentation (README, ARCHITECTURE, CONFIGURATION, DATABASE, TECHNICAL)
- [x] Docker Compose orchestration with service dependencies
- [x] Multi-network support (Clearnet, Tor, I2P, Lokinet)
- [x] Prometheus metrics integration for all services
- [x] Grafana dashboards for service monitoring
- [x] Implementation template for custom deployments
- [x] LilBrotr lightweight implementation (~60% disk savings)
- [x] Comprehensive docstrings (Google style) across all modules

### Pending

- [ ] End-to-end service validation with live relays
- [ ] Performance profiling and optimization
- [ ] Integration tests with real PostgreSQL database
- [ ] Production deployment testing

---

## Overview

Version 3.0.0 represents a comprehensive architectural refinement of BigBrotr, introducing a complete data models layer, enhanced service communication patterns, and significant improvements to code organization and maintainability.

This release establishes BigBrotr as a production-ready Nostr data archiving and monitoring platform with full NIP-11/NIP-66 compliance.

---

## Highlights

### 1. Complete Data Models Layer

A new `src/models/` package provides type-safe, immutable data structures with built-in validation:

| Model | Purpose |
|-------|---------|
| `Event` | Nostr event wrapper with cryptographic validation |
| `Relay` | URL parsing, network detection (clearnet/tor/i2p/loki), normalization |
| `EventRelay` | Event-relay junction with timestamp tracking |
| `Keys` | Nostr keypair management with hex/nsec/npub support |
| `Metadata` | Content-addressed metadata container |
| `Nip11` | Relay information document (NIP-11 compliant) |
| `Nip66` | Relay monitoring data (NIP-66 compliant) |
| `RelayMetadata` | Time-series metadata linking relays to metadata records |

All models use frozen dataclasses with validation in `__new__` to ensure immutability and data integrity.

### 2. Service Communication Pattern

Services now communicate through the `service_data` table using a standardized pattern:

```
                        SERVICE DATA FLOW
============================================================================

  +------------------+                      +------------------+
  |     SEEDER       |                      |     FINDER       |
  |   (one-shot)     |                      |   (continuous)   |
  +--------+---------+                      +--------+---------+
           |                                         |
           |  service_data                           |  service_data
           |  (validator/candidate)                  |  (validator/candidate)
           |                                         |  (finder/cursor)
           +-------------------+---------------------+
                               |
                               v
                    +----------+-----------+
                    |      VALIDATOR       |
                    |     (continuous)     |
                    +----------+-----------+
                               |
              +----------------+----------------+
              |                                 |
              v                                 v
      +-------+-------+               +---------+---------+
      |    relays     |               |   service_data    |
      | (validated)   |               | (failed_attempts) |
      +---------------+               +-------------------+
              |
              v
      +-------+-------+
      |    MONITOR    |
      |  (continuous) |
      +-------+-------+
              |
              +----------------+----------------+
              |                                 |
              v                                 v
      +-------+-------+               +---------+---------+
      |relay_metadata |               |     metadata      |
      | (snapshots)   |               | (deduplicated)    |
      +---------------+               +-------------------+
              |
              v
      +-------+-------+
      | SYNCHRONIZER  |
      |  (continuous) |
      +-------+-------+
              |
              +----------------+----------------+
              |                |                |
              v                v                v
      +-------+------+ +-------+------+ +-------+--------+
      |    events    | |events_relays | | service_data   |
      |  (collected) | | (provenance) | | (sync cursors) |
      +--------------+ +--------------+ +----------------+
```

**Key Design Decision**: Both Seeder and Finder write candidates with `service_name='validator'` so the Validator service can pick them up from a single source. This eliminates the need for the Validator to query multiple service names.

### 3. Test Suite Reorganization

Tests have been reorganized into a cleaner structure:

```
tests/
├── conftest.py              # Shared fixtures
├── unit/
│   ├── core/                # Core layer tests
│   │   ├── test_pool.py
│   │   ├── test_brotr.py
│   │   ├── test_base_service.py
│   │   └── test_logger.py
│   ├── services/            # Service layer tests
│   │   ├── test_seeder.py
│   │   ├── test_finder.py
│   │   ├── test_validator.py
│   │   ├── test_monitor.py
│   │   └── test_synchronizer.py
│   └── models/              # Models tests
│       ├── test_event.py
│       ├── test_relay.py
│       ├── test_event_relay.py
│       └── ...
└── integration/             # Integration tests (planned)
```

**Test Count**: 708 passing tests

### 4. Database Schema Enhancements

#### Content-Addressed Metadata Storage

The `metadata` table uses SHA-256 content hashing for automatic deduplication:

```sql
CREATE TABLE metadata (
    id BYTEA PRIMARY KEY,    -- SHA-256(data::TEXT)
    data JSONB NOT NULL
);
```

Multiple relays with identical NIP-11 documents share the same metadata record, saving significant storage space.

#### Relay Metadata Types

The `relay_metadata` table supports four metadata types:

| Type | Content |
|------|---------|
| `nip11` | Relay information document |
| `nip66_rtt` | Round-trip time measurements (open, read, write, dns) |
| `nip66_ssl` | SSL certificate information |
| `nip66_geo` | Geolocation data (country, city, ASN, coordinates) |

#### Tag Value Extraction

The `tags_to_tagvalues` function extracts values from single-character tag keys for efficient GIN indexing:

```sql
-- Only extracts values from standard Nostr tags (e, p, r, d, t, etc.)
SELECT array_agg(tag_element->>1)
FROM jsonb_array_elements(p_tags) AS tag_element
WHERE length(tag_element->>0) = 1
```

This enables efficient queries like:
```sql
SELECT * FROM events WHERE tagvalues @> ARRAY['event_id_hex'];
```

---

## Architecture

### Three-Layer Design

```
+===========================================================================+
|                        IMPLEMENTATION LAYER                               |
|                     implementations/bigbrotr/                             |
+---------------------------------------------------------------------------+
|                                                                           |
|   yaml/            postgres/         docker-compose    data/      .env    |
|   (configs)        (SQL schema)      (orchestration)   (seeds)    (vars)  |
|                                                                           |
+==================================+========================================+
                                   |
                                   v
+===========================================================================+
|                          SERVICE LAYER                                    |
|                          src/services/                                    |
+---------------------------------------------------------------------------+
|                                                                           |
|   +----------+  +--------+  +-----------+  +---------+  +--------------+  |
|   |  Seeder  |  | Finder |  | Validator |  | Monitor |  | Synchronizer |  |
|   |(one-shot)|  |(disco) |  |  (test)   |  |(health) |  |   (events)   |  |
|   +----------+  +--------+  +-----------+  +---------+  +--------------+  |
|                                                                           |
|   +-------+  +-------+                                                    |
|   |  API  |  |  DVM  |  (planned)                                         |
|   +-------+  +-------+                                                    |
|                                                                           |
+==================================+========================================+
                                   |
                                   v
+===========================================================================+
|                           CORE LAYER                                      |
|                           src/core/                                       |
+---------------------------------------------------------------------------+
|                                                                           |
|   +--------+     +--------+     +-------------+     +--------+            |
|   |  Pool  |     | Brotr  |     | BaseService |     | Logger |            |
|   |(conn)  |---->|(db api)|     | (lifecycle) |     |(key=v) |            |
|   +--------+     +--------+     +-------------+     +--------+            |
|                                                                           |
+==================================+========================================+
                                   |
                                   v
+===========================================================================+
|                          MODELS LAYER                                     |
|                          src/models/                                      |
+---------------------------------------------------------------------------+
|                                                                           |
|   Event   Relay   EventRelay   Keys   Metadata   Nip11   Nip66            |
|                                                                           |
|   (frozen dataclasses with __new__ validation)                            |
|                                                                           |
+===========================================================================+
```

### Service Data Flow

1. **Seeder** (one-shot): Parses `seed_relays.txt`, validates URLs, stores as candidates
2. **Finder** (continuous): Discovers URLs from APIs and events, stores as candidates
3. **Validator** (continuous): Tests candidates via WebSocket, promotes valid to `relays` table
4. **Monitor** (continuous): Health checks relays, stores NIP-11/NIP-66 metadata
5. **Synchronizer** (continuous): Collects events from relays via multiprocessing

---

## Breaking Changes from v2.x

### 1. Service Name Alignment

The Validator service now reads candidates from `service_name='validator'` instead of `service_name='finder'`. This aligns with the Seeder's behavior and simplifies the service communication model.

**Migration**: No action required for new deployments. Existing deployments with candidates stored under `service_name='finder'` will need to migrate them:

```sql
UPDATE service_data
SET service_name = 'validator'
WHERE service_name = 'finder' AND data_type = 'candidate';
```

### 2. Retry Counter Renamed

The `retries` field in candidate data has been renamed to `failed_attempts` for clarity and consistency with the Seeder service.

**Migration**: Automatic - the Validator will handle both field names gracefully.

### 3. Test Directory Structure

Tests have been moved from `tests/core/`, `tests/services/`, `tests/models/` to `tests/unit/core/`, `tests/unit/services/`, `tests/unit/models/`.

**Migration**: Update CI/CD pipelines and test commands to use `tests/unit/`.

---

## Service Details

### Seeder Service

**Purpose**: One-shot database bootstrap with relay seed data

**Workflow**:
1. Parse relay URLs from `data/seed_relays.txt`
2. Validate each URL (must be `wss://` or `ws://`)
3. Detect network type (clearnet, tor, i2p, loki)
4. Store as candidates with `service_name='validator'`

**Configuration** (`yaml/services/seeder.yaml`):
```yaml
seed:
  file_path: "data/seed_relays.txt"
```

### Finder Service

**Purpose**: Continuous relay URL discovery

**Discovery Sources**:
- **API**: External relay lists (nostr.watch)
- **Events**: Database event mining (kinds 2, 3, 10002, r-tags)

**Cursor-Based Pagination**: Uses composite cursor `(created_at, id)` to resume event scanning without duplicates or missed events.

**Configuration** (`yaml/services/finder.yaml`):
```yaml
interval: 3600.0

events:
  enabled: true

api:
  enabled: true
  sources:
    - url: https://api.nostr.watch/v1/online
      enabled: true
      timeout: 30.0

concurrency:
  max_parallel: 5
```

### Validator Service

**Purpose**: Test and validate candidate relay URLs

**Validation Process**:
1. Fetch candidates from `service_data` where `service_name='validator'`
2. Apply probabilistic selection: `P(select) = 1 / (1 + failed_attempts)`
3. Test WebSocket connectivity with configurable timeout
4. Route `.onion` URLs through Tor SOCKS5 proxy
5. On success: insert into `relays` table, delete candidate
6. On failure: increment `failed_attempts` counter

**NIP-42 Support**: If `PRIVATE_KEY` environment variable is set, the validator will attempt authentication for relays requiring it.

**Configuration** (`yaml/services/validator.yaml`):
```yaml
interval: 300.0
connection_timeout: 10.0
max_candidates_per_run: null

concurrency:
  max_parallel: 10

tor:
  enabled: true
  host: "tor"
  port: 9050
```

### Monitor Service

**Purpose**: NIP-11/NIP-66 compliant health monitoring

**Check Types**:
| Check | Description |
|-------|-------------|
| `open` | WebSocket connection test |
| `read` | REQ/EOSE subscription test |
| `write` | EVENT/OK publication test (requires private key) |
| `nip11` | Relay information document fetch |
| `ssl` | SSL certificate validation |
| `dns` | DNS resolution timing |
| `geo` | IP geolocation (requires MaxMind database) |

**Event Publishing**: Optionally publishes kind 30166 relay discovery events and kind 10166 monitor announcements.

**Configuration** (`yaml/services/monitor.yaml`):
```yaml
interval: 3600.0

checks:
  open: true
  read: true
  write: true
  nip11: true
  ssl: true
  dns: true
  geo: true

publishing:
  enabled: true
  destination: "monitored_relay"

timeouts:
  clearnet: 30.0
  tor: 60.0

concurrency:
  max_parallel: 50
  batch_size: 50
```

### Synchronizer Service

**Purpose**: High-throughput event collection with multiprocessing

**Architecture**:
- Main process distributes relays to worker pool
- Workers connect via `nostr-sdk`, collect events, return batches
- Main process inserts batches to database

**Time Range Strategy**:
- Per-relay cursors track last synced timestamp
- Lookback window prevents reprocessing old events
- Graceful handling of relay-specific overrides

**Configuration** (`yaml/services/synchronizer.yaml`):
```yaml
interval: 900.0

filter:
  kinds: null
  limit: 500

time_range:
  default_start: 0
  use_relay_state: true
  lookback_seconds: 86400

timeouts:
  clearnet:
    request: 30.0
    relay: 1800.0
  tor:
    request: 60.0
    relay: 3600.0

concurrency:
  max_parallel: 10
  max_processes: 4
  stagger_delay: [0, 60]

source:
  from_database: true
  max_metadata_age: 43200
  require_readable: true

overrides:
  - url: "wss://relay.damus.io"
    timeouts:
      request: 60.0
      relay: 7200.0
```

---

## Database Schema

### Tables

| Table | Purpose |
|-------|---------|
| `relays` | Registry of validated relay URLs |
| `events` | Nostr events with BYTEA storage |
| `events_relays` | Event-relay junction with `seen_at` timestamp |
| `metadata` | Deduplicated NIP-11/NIP-66 documents |
| `relay_metadata` | Time-series metadata linking relays to metadata |
| `service_data` | Per-service operational data (candidates, cursors) |

### SQL Files

| File | Purpose |
|------|---------|
| `00_extensions.sql` | pgcrypto, btree_gin extensions |
| `01_functions_utility.sql` | `tags_to_tagvalues` function |
| `02_tables.sql` | Table definitions |
| `03_functions_crud.sql` | Insert/upsert stored procedures |
| `04_functions_cleanup.sql` | Orphan cleanup functions |
| `05_views.sql` | Regular views (placeholder) |
| `06_materialized_views.sql` | `relay_metadata_latest` view |
| `07_functions_refresh.sql` | Materialized view refresh |
| `08_indexes.sql` | Performance indexes |
| `99_verify.sql` | Schema verification |

### Stored Procedures

| Function | Purpose |
|----------|---------|
| `insert_event` | Atomic event + relay + junction insert |
| `insert_relay` | Idempotent relay insert |
| `insert_relay_metadata` | Content-addressed metadata insert |
| `upsert_service_data` | Service data upsert |
| `get_service_data` | Service data retrieval |
| `delete_service_data` | Service data deletion |
| `delete_orphan_events` | Cleanup orphaned events |
| `delete_orphan_metadata` | Cleanup unreferenced metadata |
| `delete_failed_candidates` | Cleanup failed validation candidates |

---

## Dependencies

### Runtime

| Package | Version | Purpose |
|---------|---------|---------|
| `asyncpg` | 0.30.0 | Async PostgreSQL driver |
| `pydantic` | 2.10.4 | Configuration validation |
| `aiohttp` | 3.13.2 | Async HTTP client |
| `aiohttp-socks` | 0.10.1 | SOCKS5 proxy support |
| `aiomultiprocess` | 0.9.1 | Multicore processing |
| `nostr-sdk` | 0.39.0 | Nostr protocol (rust-nostr bindings) |
| `PyYAML` | 6.0.2 | YAML parsing |
| `rfc3986` | 2.0.0 | URL parsing and validation |
| `geoip2` | 4.8.1 | IP geolocation |
| `pyOpenSSL` | 25.0.0 | SSL certificate handling |

### Development

| Package | Version | Purpose |
|---------|---------|---------|
| `pytest` | 8.3.5 | Testing framework |
| `pytest-asyncio` | 0.26.0 | Async test support |
| `pytest-cov` | 6.1.1 | Coverage reporting |
| `ruff` | 0.11.6 | Linting and formatting |
| `mypy` | 1.15.0 | Type checking |
| `pre-commit` | 4.2.0 | Git hooks |

---

## Deployment

### Docker Compose

```bash
cd implementations/bigbrotr
cp .env.example .env
nano .env  # Set DB_PASSWORD and PRIVATE_KEY

docker-compose up -d
docker-compose logs -f
```

### Service Dependencies

```
+------------+                           +-----+
|  postgres  |                           | tor |
+-----+------+                           +--+--+
      |                                     |
      v                                     |
+------------+                              |
| pgbouncer  |                              |
+-----+------+                              |
      |                                     |
      v                                     |
+------------+                              |
|   seeder   |  (one-shot)                  |
+-----+------+                              |
      |                                     |
      v                                     |
+------------+                              |
|   finder   |                              |
+-----+------+                              |
      |                                     |
      v                                     |
+------------+<-----------------------------+
| validator  |  (uses Tor for .onion)       |
+-----+------+                              |
      |                                     |
      v                                     |
+------------+<-----------------------------+
|  monitor   |  (uses Tor for .onion)       |
+-----+------+                              |
      |                                     |
      v                                     |
+--------------+<---------------------------+
| synchronizer |  (uses Tor for .onion)
+--------------+
```

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `DB_PASSWORD` | Yes | PostgreSQL password |
| `PRIVATE_KEY` | No | Nostr private key (hex or nsec) for NIP-42 auth and write tests |

---

## Testing

```bash
# Run all tests
pytest tests/ -v

# Run with coverage
pytest tests/ --cov=src --cov-report=html

# Run specific service tests
pytest tests/unit/services/test_validator.py -v

# Run specific test by pattern
pytest -k "probabilistic_selection" -v
```

**Coverage**: Target 80%+ across all modules

---

## Known Issues

1. **Materialized View Refresh**: The `relay_metadata_latest` view requires manual or scheduled refresh via `REFRESH MATERIALIZED VIEW CONCURRENTLY relay_metadata_latest;`

2. **Multiprocess Database Connections**: When `max_processes > 1`, each worker creates its own database connection pool. Monitor connection limits accordingly.

3. **GeoIP Database**: The Monitor service's geo check requires a MaxMind GeoLite2-City database. Without it, geolocation data will be empty.

---

## Migration Guide

### From v2.x to v3.0.0

1. **Update test paths** in CI/CD:
   ```yaml
   # Old
   pytest tests/services/

   # New
   pytest tests/unit/services/
   ```

2. **Migrate finder candidates** (if any exist):
   ```sql
   UPDATE service_data
   SET service_name = 'validator'
   WHERE service_name = 'finder'
   AND data_type = 'candidate';
   ```

3. **Database schema**: Run new SQL files:
   ```bash
   psql -U admin -d bigbrotr -f postgres/init/07_functions_refresh.sql
   ```

4. **Environment**: No changes required

---

## License

MIT License. See [LICENSE](../LICENSE) for details.

---

**Built for the Nostr ecosystem.**
